<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Super Admin MI Bendiljati Wetan</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        :root { --primary: #043927; --accent: #d4af37; --bg: #f4f7f6; --white: #ffffff; }
        body { font-family: sans-serif; margin: 0; background: var(--bg); display: none; }
        .admin-container { display: grid; grid-template-columns: 260px 1fr; min-height: 100vh; }
        
        /* Sidebar */
        .sidebar { background: var(--primary); color: white; padding: 20px; border-right: 4px solid var(--accent); }
        .nav-item { padding: 12px; margin: 5px 0; cursor: pointer; border-radius: 8px; transition: 0.3s; display: flex; align-items: center; gap: 10px; }
        .nav-item:hover, .nav-item.active { background: var(--accent); color: var(--primary); font-weight: bold; }
        
        /* Content */
        main { padding: 30px; }
        .card { background: var(--white); padding: 25px; border-radius: 12px; box-shadow: 0 5px 15px rgba(0,0,0,0.05); margin-bottom: 20px; }
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .full { grid-column: span 2; }
        
        input, textarea, select { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; margin-top: 5px; }
        .btn { padding: 12px 20px; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; transition: 0.3s; }
        .btn-save { background: var(--primary); color: white; width: 100%; }
        
        table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        th, td { padding: 12px; border-bottom: 1px solid #eee; text-align: left; }
        .loading-overlay { position: fixed; inset: 0; background: rgba(255,255,255,0.7); display: none; align-items: center; justify-content: center; z-index: 100; }
    </style>
</head>
<body>

<div id="loading-overlay"><i class="fas fa-spinner fa-spin fa-2x"></i></div>

<div class="admin-container">
    <aside class="sidebar">
        <h3>MI BENDILJATI</h3>
        <div class="nav-item active" onclick="showSection('dashboard', this)"><i class="fas fa-home"></i> Dashboard</div>
        <div class="nav-item" onclick="showSection('berita', this)"><i class="fas fa-newspaper"></i> Berita</div>
        <div class="nav-item" onclick="showSection('prestasi', this)"><i class="fas fa-trophy"></i> Prestasi</div>
        <div class="nav-item" onclick="showSection('guru', this)"><i class="fas fa-chalkboard-teacher"></i> Data Guru</div>
        <div class="nav-item" onclick="showSection('layanan', this)"><i class="fas fa-concierge-bell"></i> Layanan</div>
        <div class="nav-item" onclick="showSection('slider', this)"><i class="fas fa-images"></i> Slider</div>
    </aside>

    <main>
        <div id="section-dashboard" class="section">
            <div class="card">
                <h3><i class="fas fa-chart-line"></i> Statistik Sekolah</h3>
                <div class="grid">
                    <div><label>Jumlah Siswa</label><input type="number" id="stat-siswa"></div>
                    <div><label>Jumlah Guru</label><input type="number" id="stat-guru"></div>
                    <div><label>Jumlah Ekskul</label><input type="number" id="stat-ekskul"></div>
                    <button class="btn btn-save full" onclick="updateDashboard('stats')">Update Statistik</button>
                </div>
            </div>
            <div class="card">
                <h3><i class="fas fa-bullseye"></i> Visi & Misi</h3>
                <label>Visi</label><textarea id="visi-text" rows="2"></textarea>
                <label>Misi</label><textarea id="misi-text" rows="4"></textarea>
                <button class="btn btn-save" style="margin-top:10px" onclick="updateDashboard('visiMisi')">Update Visi & Misi</button>
            </div>
        </div>

        <div id="section-crud" class="section" style="display:none">
            <div class="card">
                <h3 id="form-title">Tambah Data</h3>
                <div id="dynamic-form" class="grid">
                    </div>
                <button class="btn btn-save" style="margin-top:15px" onclick="handleSubmit()" id="btn-submit">Simpan Data</button>
            </div>
            <div class="card">
                <h3>Daftar Data</h3>
                <div id="data-list"></div>
            </div>
        </div>
    </main>
</div>

<script>
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzXZIrK-08GhyfiNBo7ErWeM8dtWQTTYoORGubt0HBM-Df03xdVOIheF19asYHpm7TKPw/exec";
    let allData = {};
    let currentTab = 'dashboard';
    let editId = null;

    // Login
    const pass = prompt("Password Admin:");
    if (pass === "biasabisa") { document.body.style.display = "block"; loadAllData(); }
    else { window.location.href = "index.html"; }

    async function loadAllData() {
        toggleLoader(true);
        const res = await fetch(SCRIPT_URL);
        allData = await res.json();
        
        // Fill Dashboard
        document.getElementById('stat-siswa').value = allData.stats.siswa;
        document.getElementById('stat-guru').value = allData.stats.guru;
        document.getElementById('stat-ekskul').value = allData.stats.ekskul;
        document.getElementById('visi-text').value = allData.visiMisi.visi;
        document.getElementById('misi-text').value = allData.visiMisi.misi;
        
        if (currentTab !== 'dashboard') renderCrudTable();
        toggleLoader(false);
    }

    function showSection(tab, el) {
        currentTab = tab;
        document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
        el.classList.add('active');
        
        document.getElementById('section-dashboard').style.display = tab === 'dashboard' ? 'block' : 'none';
        document.getElementById('section-crud').style.display = tab === 'dashboard' ? 'none' : 'block';
        
        if (tab !== 'dashboard') {
            generateForm();
            renderCrudTable();
        }
    }

    function generateForm() {
        const form = document.getElementById('dynamic-form');
        const configs = {
            berita: ['Judul', 'Tanggal', 'Isi', 'Link Gambar'],
            prestasi: ['Nama Prestasi', 'Kategori', 'Link Gambar'],
            guru: ['Nama Guru', 'Jabatan', 'Link Foto'],
            layanan: ['Nama Layanan', 'Deskripsi', 'Link Gambar'],
            slider: ['Link Gambar Slider']
        };
        
        const fields = configs[currentTab];
        form.innerHTML = fields.map((f, i) => `
            <div class="${f === 'Isi' || f === 'Deskripsi' ? 'full' : ''}">
                <label>${f}</label>
                ${f === 'Isi' || f === 'Deskripsi' ? `<textarea id="inp-${i}" rows="4"></textarea>` : `<input type="text" id="inp-${i}">`}
            </div>
        `).join('');
        editId = null;
        document.getElementById('btn-submit').innerText = "Simpan Data";
    }

    async function updateDashboard(type) {
        toggleLoader(true);
        const data = type === 'stats' ? {
            siswa: document.getElementById('stat-siswa').value,
            guru: document.getElementById('stat-guru').value,
            ekskul: document.getElementById('stat-ekskul').value
        } : {
            visi: document.getElementById('visi-text').value,
            misi: document.getElementById('misi-text').value
        };

        await fetch(SCRIPT_URL, { method: 'POST', body: JSON.stringify({ action: 'updateDashboard', type, data }) });
        alert("Berhasil!");
        loadAllData();
    }

    async function handleSubmit() {
        toggleLoader(true);
        const sheetMapping = { berita: 'Berita', prestasi: 'Prestasi', guru: 'Guru', layanan: 'Layanan', slider: 'Slider' };
        const data = [];
        let i = 0;
        while(document.getElementById(`inp-${i}`)) {
            data.push(document.getElementById(`inp-${i}`).value);
            i++;
        }

        const payload = {
            action: editId ? 'edit' : 'add',
            sheetName: sheetMapping[currentTab],
            id: editId,
            data: data
        };

        await fetch(SCRIPT_URL, { method: 'POST', body: JSON.stringify(payload) });
        alert("Berhasil!");
        location.reload();
    }

    function renderCrudTable() {
        const key = currentTab === 'guru' ? 'dataGuru' : currentTab;
        const items = allData[key] || [];
        const container = document.getElementById('data-list');
        
        let html = `<table><tr><th>Info</th><th>Aksi</th></tr>`;
        items.forEach(item => {
            html += `<tr>
                <td><strong>${item[0]}</strong></td>
                <td>
                    <button onclick="prepareEdit('${item[0]}', ${JSON.stringify(item).replace(/"/g, '&quot;')})">Edit</button>
                    <button onclick="deleteData('${item[0]}')" style="color:red">Hapus</button>
                </td>
            </tr>`;
        });
        container.innerHTML = html + `</table>`;
    }

    function prepareEdit(id, data) {
        editId = id;
        data.forEach((val, i) => {
            if(document.getElementById(`inp-${i}`)) document.getElementById(`inp-${i}`).value = val;
        });
        document.getElementById('btn-submit').innerText = "Update Data";
        window.scrollTo(0,0);
    }

    async function deleteData(id) {
        if(!confirm("Hapus data ini?")) return;
        toggleLoader(true);
        const sheetMapping = { berita: 'Berita', prestasi: 'Prestasi', guru: 'Guru', layanan: 'Layanan', slider: 'Slider' };
        await fetch(SCRIPT_URL, { method: 'POST', body: JSON.stringify({ action: 'delete', sheetName: sheetMapping[currentTab], id: id }) });
        location.reload();
    }

    function toggleLoader(show) { document.getElementById('loading-overlay').style.display = show ? 'flex' : 'none'; }
</script>
</body>
</html>
